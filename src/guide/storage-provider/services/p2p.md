---
title: P2P
order: 2
---

# P2P

P2P is responsible for the interaction of control flow between SPs.

## Ping Service

SP abandoned the conventional p2p ping service, because the conventional ping service is managed and communicated in 
units of p2p nodes, without considering the fairness between SPs, the SP's p2p service is more inclined to synchronize 
messages to different SPs, instead of synchronous p2p nodes. For this purpose we have customized ping service.

The customized ping service implements dynamic update of p2p permanent nodes. As usual, permanent nodes should cover as 
many SPs as possible, which is more decentralized, eg: get replicate approval request needs at least 6 or more replies 
from different SPs but p2p node are offline and replacement, which is an inevitable problem, If nodes belonging to the 
same sp all fail and are replaced, then the sp will be unable to communicate, this requires dynamic updates permanent nodes.

The customized ping service also implements the pruning function of permanent nodes. For zombie nodes, pruning strategy 
takes into account the information of the SP dimension, and uses a very conservative pruning strategy. Nodes are only 
pruned if there are enough backups for one SP and multiple failed interactions, can try to keep each SP with enough nodes 
to try to connect, so that each sp has an equal opportunity to receive requests

```protobuf
// Ping defines the heartbeat request between p2p nodes
message Ping {
  // sp_operator_address define sp operator public key
  string sp_operator_address = 1;
  // signature define the signature of sp sign the msg
  bytes signature = 2;
}

// Node defines the p2p node info
message Node {
  // node_id defines the node id
  string node_id = 1;
  // multi_addr define the node multi addr
  repeated string multi_addr = 2;
}

// Pong defines the heartbeat response between p2p nodes
message Pong {
  // nodes define the
  repeated Node nodes = 1;
  // sp_operator_address define sp operator public key
  string sp_operator_address = 2;
  // signature define the signature of sp sign the msg
  bytes signature = 3;
}

```

## GetReplicateApproval Service

rimary SP sends GetApprovalRequest to other SPs, asking if they are willing to serve as obeject's secondary SP through
the p2p GetReplicateApproval service. The GetReplicateApproval service offers GetReplicateApproval interface, the params
includes ObjectInfo is used to make decisions for other SPs whether they are willing to accept approval, expectedAccept
expectedAccept indicates that it can return after receiving the number of approvals, timeout means that it can return 
after the timeout and has not received expectedAccept approvals in time.

```go
GetReplicateApproval(object *storagetypes.ObjectInfo, expectedAccept int, timeout int64) 
```

GetApprovalRequest includes in addition to the object info, the primary SP operator address that used to check whether 
it is a valid SP, and signature that generated by primary SP signing the request used to verify the request 
and SP operator address match.

```protobuf
// GetApprovalRequest defines the request of getting approval
message GetApprovalRequest {
  // object_info define the object info for getting approval
  bnbchain.greenfield.storage.ObjectInfo object_info = 1;
  // sp_operator_address define sp operator public key
  string sp_operator_address = 2;
  // signature define the signature of sp sign the msg
  bytes signature = 4;
}
```

GetApprovalResponse additionally adds expired time if the SP ack approval, it will be given a valid deadline and 
refused reason if the SP refuses the approval, will be given the reason.

```protobuf
// GetApprovalResponse defines the response of getting approval
message GetApprovalResponse {
  // object_info define the object info for getting approval
  bnbchain.greenfield.storage.ObjectInfo object_info = 1;
  // sp_operator_address define sp operator public key
  string sp_operator_address = 2;
  // expired_time defines the approval valid deadline
  int64 expired_time = 3;
  // refused_reason defines the reason of refusing
  string refused_reason = 4;
  // signature define the signature of sp sign the msg
  bytes signature = 5;
}
```